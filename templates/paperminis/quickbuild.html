{% extends "base_generic.html" %}

{% block header %}
{% endblock %}

{% block content %}
    {{ form.errors }}
    {% load widget_tweaks %}
    <form action="" method="post">
        {% csrf_token %}
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header ">
                        <h4 class="card-title">Creature List</h4>
                        <p class="card-category">Add creatures here to print them directly!</p>
                    </div>
                    <div class="card-body">
                        <!-- Button trigger modal -->
                        {% if request.user.is_authenticated %}
                            <button type="button" class="btn btn-fill btn-block"
                                    data-toggle="modal" data-target="#CollectionOrNewModal">
                                Add another creature
                            </button>
                        {% else %}
                            <button type="button" class="btn btn-fill btn-block" id="add_more">
                                Add another creature
                            </button>
                        {% endif %}

                        <!-- CollectionOrNewModal -->
                        <div class="modal fade bd-example-modal-sm" id="CollectionOrNewModal" tabindex="-1"
                             role="dialog" aria-labelledby="CollectionOrNewModal" aria-hidden="true">
                            <div class="modal-dialog ">
                                <div class="modal-content">
                                    <div class="modal-header">
                                    </div>
                                    <div class="modal-body">
                                        <button type="button" class="btn btn-fill btn-block" id="add_more"
                                                data-dismiss="modal">
                                            Create a quick create
                                        </button>
                                        <button type="button" class="btn btn-fill btn-block"
                                                id="btn_collection_creature" data-dismiss="modal"
                                                onclick="collection_modal();return false;">
                                            Choose from your collection (DOES NOT WORK, YET)
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- All added Creatures sofar... -->
                        <p></p>
                        {{ creature_formset.management_form }}
                        <div id="formset_wrapper">
                            {% for form in creature_formset.forms %}
                                {{form.non_field_errors}}
                                {{form.errors}}
                                <table class='no_error'>
                                    {{ form.as_table }}
                                </table>
                            {% endfor %}
                        </div>
                        <div id="emptyform_wrapper" style="display:none">
                            <table class='no_error'>
                                {{ creature_formset.empty_form.as_table }}
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div id="fixcard" class="card">
                    <div class="card-header ">
                        <h4 class="card-title">Printing Settings</h4>
                    </div>
                    <div class="card-body">
                        <label>Once you added how many creatures you want of each, add them to your bestiary</label>
                        <div id="form">
                                {% csrf_token %}
                            <div class="form-group">
                                {{ settings_form.paper_format.errors }}
                                <label for="{{ settings_form.paper_format.id_for_label }}">Paper Format:</label>
                                {% render_field settings_form.paper_format class+="form-control" %}
                            </div>
                            <div class="form-group">
                                {{ settings_form.grid_size.errors }}
                                <label for="{{ settings_form.grid_size.id_for_label }}">Grid Size:</label>
                                {% render_field settings_form.grid_size class+="form-control" %}
                            </div>
                            <div class="form-group">
                                {{ settings_form.base_shape.errors }}
                                <label for="{{ settings_form.base_shape.id_for_label }}">Base Shape:</label>
                                {% render_field settings_form.base_shape class+="form-control" %}
                            </div>
                            <div class="form-group">
                                {{ settings_form.force_name.errors }}
                                <label for="{{ settings_form.force_name.id_for_label }}">Print all names, print no names or leave it to the creature settings</label>
                                {% render_field settings_form.force_name class+="form-control" %}
                            </div>
                            <div class="form-group">
                                {{ settings_form.enumerate.errors }}
                                <label for="{{ settings_form.enumerate.id_for_label }}">Add numbers to the base of minis where you have more than one?</label>
                                {% render_field settings_form.enumerate class+="form-control" %}
                            </div>
                            <div class="form-group">
                                {{ settings_form.fixed_height.errors }}
                                <label for="{{ settings_form.fixed_height.id_for_label }}">Use fixed height for minis of the same size category?</label>
                                {% render_field settings_form.fixed_height class+="form-control" %}
                            </div>

{% comment %}
                            {% for form in settings_formset.forms %}
                                {{form.non_field_errors}}
                                {{form.errors}}
                                <table class='no_error'>
                                    {{ form }}
                                </table>
                            {% endfor %}
{% endcomment %}
                        </div>
                        <input class="btn btn-success btn-fill btn-block mt-1 mb-2" type="submit" value="Print"/>
                    </div>
                </div>
                <div id="cpreview" class="card" style="visibility: hidden">
                    <div class="card-body">
                        <div class="container text-center">
                            <img id="ipreview" src="" class="rounded img-fluid" alt="Creature preview."
                                 style="z-index: 999">
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </form>
{% endblock %}

{% block script %}
<script>
  $('#add_more').click(function () {
    let total_form = $('#id_creatures-TOTAL_FORMS');
    let form_idx = total_form.val();

    $('#formset_wrapper').append($('#emptyform_wrapper').html().replace(/__prefix__/g, form_idx));
    total_form.val(parseInt(form_idx)+1);
  });

function creature_preview(e, url) {
    var topdiv = document.getElementById('fixcard');
    var div = document.getElementById('cpreview');
    var rect1 = topdiv.getBoundingClientRect();
    var rect2 = div.getBoundingClientRect();
    var overlap = !(rect1.right < rect2.left ||
        rect1.left > rect2.right ||
        rect1.bottom < rect2.top ||
        rect1.top > rect2.bottom)
    img = document.getElementById('ipreview');
    img.src = url;
    div.style.visibility = "visible";
    var abs_top = div.getBoundingClientRect().top
    var scrollTop = (window.pageYOffset !== undefined) ? window.pageYOffset : (document.documentElement || document.body.parentNode || document.body).scrollTop;
    if (abs_top <= 0 && !overlap) {
        div.style.position = "fixed";
        div.style.top = "0px";
    } else if (overlap) {
        div.style.position = "relative";
    }
}

</script>
{% endblock %}